# proj10实训一：裸机程序

## 背景了解：异常与中断

------

proj10题目是基于LoongArch32架构的一个教学操作系统展开的，实训一需要编写裸机程序并进行异常中断相关问题解决。所以我先去了解操作系统中与异常中断相关的基础知识点以及其他与实训相关的拓展知识。

[TOC]

### 一、中断与异常

​	**中断**（Interrupt）和**异常**（Exception）是指明系统、处理器或当前执行程序（或任务）的某处出现一个事件，该事件需要处理器进行处理。在proj10的LoongArch32架构下，题目所说的异常被表述为“例外”（参考龙芯架构32位精简版参考手册v1.03）。

#### 1.中断

> [!NOTE]
>
> ​	中断根据中断源的不同，分为硬件中断和软件中断两部分，而硬件中断又可以被分位外部中断和内部中断。中断机制赋予了设备通知CPU的能力，使CPU去处理这个中断。操作系统也可以为不同的设备中断配置不同的中断处理函数。

​	在龙芯32位架构中，每个处理器核可记录12个线中断，分别是：1 个核间中断（IPI），1个定时器中断（TI），8个硬中断（HWI0-HWI7），2个软中断（SWI0-SWI1）。所有 的线中断都是电平中断，且都是高电平有效。

​	而核间中断的中断输入来自于核外的中断控制器，其被处理器核采样记录在CSR.ESTAT.IS[12]位。

​	定时器中断的中断源来自于核内的恒定频率定时器。当恒定频率定时器倒计时至全0值时，该中断被 置起。置起后的定时器中断被处理器核采样记录在CSR.ESTAT.IS[11]位。清除定时器中断需要通过软件向 CSR.TICLR 寄存器的TI位写1来完成。这一部分应该对应实训中的时钟中断处理。

​	硬中断的中断源来自于处理器核外部，其直接来源通常是核外的中断控制器。8个硬中断HWI[7:0]被处 理器核采样记录在CSR.ESTAT.IS[9:2]位。 软中断的中断源来自于处理器核内部，软件通过CSR指令对CSR.ESTAT.IS[1:0]写1则置起软中断，写 0 则清除软中断。

#### 2.异常

> [!NOTE]
>
> ​	异常发生在**处理器执行指令**检测到错误条件时，例如除0错误。处理器可以检测到各种出错条件，包括违反保护机制、页错误以及机器内部错误。

> [!IMPORTANT]
>
> ​	需要注意的是，在龙芯架构下，例外优先级遵循两个基本原则：**其一，中断的优先级高于例外**；其二，对于例外，取指阶段检测出的 优先级最高，译码阶段检测出的优先级次之，执行阶段检测出的优先级再次之。

#### 3.中断与异常的处理

​	通常中断和异常会导致执行控制被强迫从当前运行程序转移到被称为中断处理程序（interrupt handler）或异常处理程序（exception handler）的特殊软件函数或任务中。处理器响应中断或异常所采取的行动被称为中断/异常服务（处理）。**被中断程序的恢复过程并不会失去程序执行的连贯性，除非异常是不可恢复的或者中断导致当前运行程序被终止。**

### 二、裸机程序

#### 1.什么是裸机程序？

​	裸机程序，即可以在**无操作系统环境**与库支持下独立运行的程序。裸机程序的特点在于进行一些特权操作或者硬件设备的 I/O 操作时，程序需要自己完成，无法让操作系统代劳。而且裸机程序通常以二进制的形式存在于ROM或磁盘固定位置。

#### 2.裸机程序的启动与运行过程

​	一般机器通电或者复位后，CPU会从某一个约定内存地址开始执行指令，一般为加载程序（loader）或者硬件初始化程序（BIOS等），随后尝试加载系统引导程序，跳转到**“入口”**，加载内核并进入到内核入口完成启动。对于一个裸机程序，通俗想法就是把常规机器启动入口替换为裸机程序的入口，完成程序的执行。详细的知识需要阅读实训相关内容进行实操。

