# proj10实训一：裸机程序

# 第一关理解中断与异常

------

## 1 知识阅读

### 1.1 中断与异常定义

​	操作系统需要对计算机系统中的各种外设进行管理，这就需要CPU和外设能够相互通信才行。一般外设的速度远慢于CPU的速度。如果让操作系统通过CPU“主动关心”外设的事件，即采用通常的轮询(polling)机制，则太浪费CPU资源了。所以需要操作系统和CPU能够一起提供某种机制，让外设在需要操作系统处理外设相关事件的时候，能够“主动通知”操作系统，即打断操作系统和应用的正常执行，让操作系统完成外设的相关处理，然后再恢复操作系统和应用的正常执行。在操作系统中，这种机制称为中断机制。中断机制给操作系统提供了处理意外情况的能力，同时它也是实现进程/线程抢占式调度的一个重要基石。但中断的引入会导致对操作系统的理解更加困难。在LoongArch32架构中，中断属于异常(Exception)的一种。

### 1.2 时钟中断

​	LoongArch32的CSR提供了一个时钟定时器，操作系统可以通过CSR指令配置该定时器，从而实现硬件产生时钟中断，使得操作系统能够进行分时调度。

> [!NOTE]
>
> ​	这一块还需要阅读龙芯32位精简版指令集手册v1.03，主要关注相关寄存器的适用

### 1.3 串口中断

​	我们的QEMU以及Chiplab SoC上都有一个NS16550a兼容的串口控制器，该控制器在很多种情况下都会有中断产生（大家可以自行查阅ns16550有关资料），在本实验中我们暂时只需要知道，串口有输入时会产生中断。在LoongArch32的QEMU以及Chiplab SoC上，串口连接的中断为HWI[0]。

### 1.4 例外产生

​	当例外产生时，处理器 硬件 会进行如下操作（这些操作由硬件完成，不会出现在操作系统代码中）：

​	[1] 将CSR.CRMD的PLV、IE分别存到CSR.PRMD的PPLV和IE中，然后将CSR.CRMD的PLV置为0，IE置为0。
​	[2] 将触发例外指令的PC值记录到CSR.ERA中
​	[3] 跳转到例外入口处取值。（如果是TLB相关例外跳转到CSR.RFBASE，否则为CSR.EBASE）然后将PC跳转到对应的例外入口地址处，交给软件完成例外的处理操作。

### 1.5 操作系统响应异常

> [!NOTE]
>
> ​	这一块阅读资料较长，概括来说操作系统首先会适用CSR保存寄存器的状态，用来确保不会破坏例外现场。随后判断异常发送位置并决定是否下陷。然后开辟空间保存异常现场，进入到**异常处理程序**。当处理完毕后，CPU会跳转执行异常发生前的指令，并从信息栈还原之前保存的现场，继续执行。

## 2 题目解答

### 2.1 解答结果

<img src="F:\study\操作系统\OS_comp\picture\61E695C9A94B70D2C13B850B560FDEAD.png" style="zoom:67%;" />

### 2.2 问题详解

#### 题目1.<img src="F:\study\操作系统\OS_comp\picture\A52CC78E5D92FB37BA300C0978CB3F8F.png" style="zoom: 67%;" />

答：在前面知识阅读可以得知，时钟中断一般是为了进行分时调度，那么就与任务调度相关；并且时钟关系到整个处理器的同步与系统的一致性，因此还需要定期触发维护系统时间。因此选择A。B项的进程管理，C，D项的存储控制均不是时钟中断的目标。

#### 题目2.<img src="F:\study\操作系统\OS_comp\picture\937AEC3BA25BF5FA7EFCB544420F1DB8.png" style="zoom: 67%;" />

答：操作系统通过异常处理机制完成异常的捕获与处理。在知识阅读中有整理。

#### 题目3.<img src="F:\study\操作系统\OS_comp\picture\D45134A01BE0C2423B2A48820755D165.png" style="zoom: 67%;" />

答：定时器关系到时钟中断，由操作系统维护，其周期由操作系统内核自行决定的，不由用户决定。

#### 题目4，5，6.<img src="F:\study\操作系统\OS_comp\picture\6D66C04F6664F853235B38EA20D3D7BA.png" style="zoom: 67%;" />

答：裸机程序是指运行在无操作系统环境中的程序，4正确；异常与中断不相同，在龙芯32位精简指令集架构中，例外（异常）优先级低于中断，异常包含中断，5错误；异常发生的时候，操作系统会运行异常处理程序进行异常捕获与处理，6正确；
